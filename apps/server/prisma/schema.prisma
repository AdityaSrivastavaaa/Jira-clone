generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

//////////////////////
// ENUMS
//////////////////////

enum OrgRole {
  OWNER
  ADMIN
  MEMBER
}

enum IssueType {
  BUG
  TASK
  STORY
}

enum IssueStatus {
  BACKLOG
  TODO
  IN_PROGRESS
  REVIEW
  DONE
}

enum IssuePriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

//////////////////////
// MODELS
//////////////////////

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organizations OrganizationMember[]
  reportedIssues Issue[] @relation("Reporter")
  assignedIssues Issue[] @relation("Assignee")
  comments       Comment[]
  activities     IssueActivityLog[]
}

model Organization {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  members  OrganizationMember[]
  projects Project[]
}

model OrganizationMember {
  id             String   @id @default(uuid())
  role           OrgRole
  createdAt      DateTime @default(now())

  userId         String
  organizationId String

  user           User         @relation(fields: [userId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@unique([userId, organizationId])
}

model Project {
  id             String   @id @default(uuid())
  name           String
  key            String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  deletedAt      DateTime?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  issues Issue[]
  labels Label[]

  @@unique([organizationId, key])
}


model Issue {
  id          String        @id @default(uuid())
  title       String
  description String?
  type        IssueType
  status      IssueStatus
  priority    IssuePriority
  position    Int
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  deletedAt   DateTime?

  projectId   String
  reporterId  String
  assigneeId  String?

  project     Project @relation(fields: [projectId], references: [id])
  reporter    User    @relation("Reporter", fields: [reporterId], references: [id])
  assignee    User?   @relation("Assignee", fields: [assigneeId], references: [id])

  comments   Comment[]
  labels     IssueLabel[]
  activities IssueActivityLog[]

  @@index([projectId, status])
}

model Comment {
  id        String   @id @default(uuid())
  content   String
  createdAt DateTime @default(now())

  issueId   String
  userId    String

  issue     Issue @relation(fields: [issueId], references: [id])
  user      User  @relation(fields: [userId], references: [id])
}

model Label {
  id        String   @id @default(uuid())
  name      String
  color     String

  projectId String
  project   Project @relation(fields: [projectId], references: [id])

  issues    IssueLabel[]

  @@unique([projectId, name])
}

model IssueLabel {
  issueId String
  labelId String

  issue Issue @relation(fields: [issueId], references: [id])
  label Label @relation(fields: [labelId], references: [id])

  @@id([issueId, labelId])
}

model IssueActivityLog {
  id        String   @id @default(uuid())
  action    String
  createdAt DateTime @default(now())

  issueId   String
  userId    String

  issue     Issue @relation(fields: [issueId], references: [id])
  user      User  @relation(fields: [userId], references: [id])
}
